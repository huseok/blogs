<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>android 启动过程源代码分析 | HZ BLOG</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blogs/favicon.ico">
    <meta name="description" content="学习笔记，记录生活">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.593f90fc.css" as="style"><link rel="preload" href="/blogs/assets/js/app.f7ee3a0f.js" as="script"><link rel="preload" href="/blogs/assets/js/7.1cee44e5.js" as="script"><link rel="preload" href="/blogs/assets/js/2.c6a51781.js" as="script"><link rel="preload" href="/blogs/assets/js/1.72bf0bc0.js" as="script"><link rel="preload" href="/blogs/assets/js/42.1e110cc6.js" as="script"><link rel="prefetch" href="/blogs/assets/js/10.f023290e.js"><link rel="prefetch" href="/blogs/assets/js/11.cc887646.js"><link rel="prefetch" href="/blogs/assets/js/14.3cd6dabc.js"><link rel="prefetch" href="/blogs/assets/js/15.19ff40c3.js"><link rel="prefetch" href="/blogs/assets/js/16.36891570.js"><link rel="prefetch" href="/blogs/assets/js/17.716cfd6e.js"><link rel="prefetch" href="/blogs/assets/js/18.39ca04e2.js"><link rel="prefetch" href="/blogs/assets/js/19.3dbfe40f.js"><link rel="prefetch" href="/blogs/assets/js/20.d3401ea4.js"><link rel="prefetch" href="/blogs/assets/js/21.61a3f302.js"><link rel="prefetch" href="/blogs/assets/js/22.77f6fc7b.js"><link rel="prefetch" href="/blogs/assets/js/23.6c9b4c97.js"><link rel="prefetch" href="/blogs/assets/js/24.89c7e42e.js"><link rel="prefetch" href="/blogs/assets/js/25.b6345202.js"><link rel="prefetch" href="/blogs/assets/js/26.b2d84ceb.js"><link rel="prefetch" href="/blogs/assets/js/27.af5fc6db.js"><link rel="prefetch" href="/blogs/assets/js/28.16433ce2.js"><link rel="prefetch" href="/blogs/assets/js/29.ca0e0baf.js"><link rel="prefetch" href="/blogs/assets/js/3.e5ee5542.js"><link rel="prefetch" href="/blogs/assets/js/30.d9c21530.js"><link rel="prefetch" href="/blogs/assets/js/31.ed3be54f.js"><link rel="prefetch" href="/blogs/assets/js/32.db95b0cf.js"><link rel="prefetch" href="/blogs/assets/js/33.6dd8bdbb.js"><link rel="prefetch" href="/blogs/assets/js/34.adc43df4.js"><link rel="prefetch" href="/blogs/assets/js/35.ffe5af3a.js"><link rel="prefetch" href="/blogs/assets/js/36.4182eee5.js"><link rel="prefetch" href="/blogs/assets/js/37.d4d6995f.js"><link rel="prefetch" href="/blogs/assets/js/38.0ee01a96.js"><link rel="prefetch" href="/blogs/assets/js/39.3854c08d.js"><link rel="prefetch" href="/blogs/assets/js/4.31b240cc.js"><link rel="prefetch" href="/blogs/assets/js/40.204ab293.js"><link rel="prefetch" href="/blogs/assets/js/41.8fbaf655.js"><link rel="prefetch" href="/blogs/assets/js/43.f3429381.js"><link rel="prefetch" href="/blogs/assets/js/44.01061a74.js"><link rel="prefetch" href="/blogs/assets/js/45.6bc3e5e4.js"><link rel="prefetch" href="/blogs/assets/js/46.a8f93001.js"><link rel="prefetch" href="/blogs/assets/js/47.cd1a11f5.js"><link rel="prefetch" href="/blogs/assets/js/48.0af1db68.js"><link rel="prefetch" href="/blogs/assets/js/49.0a5c1de1.js"><link rel="prefetch" href="/blogs/assets/js/5.854f27f6.js"><link rel="prefetch" href="/blogs/assets/js/6.3ada963c.js"><link rel="prefetch" href="/blogs/assets/js/8.7303aede.js"><link rel="prefetch" href="/blogs/assets/js/9.0c120f88.js"><link rel="prefetch" href="/blogs/assets/js/vendors~docsearch.e2810cce.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.593f90fc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>HZ BLOG</h3> <p class="description" data-v-59e6cb88>学习笔记，记录生活</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>hz</span>
          
        <!---->
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><img src="/blogs/avatar.jpg" alt="HZ BLOG" class="logo"> <span class="site-name">HZ BLOG</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      android 
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/categories/android/" class="nav-link"><i class="undefined"></i>
  android
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/源码分析/" class="nav-link"><i class="undefined"></i>
  源码分析
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/systrace/" class="nav-link"><i class="undefined"></i>
  systrace
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/java/" class="nav-link"><i class="undefined"></i>
  java
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      hz 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/blogs/android/read-source-code/.html" class="nav-link"><i class="undefined"></i>
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/blogs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/blogs/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    hz
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>11</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>7</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blogs/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      android 
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/categories/android/" class="nav-link"><i class="undefined"></i>
  android
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/源码分析/" class="nav-link"><i class="undefined"></i>
  源码分析
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/tool/" class="nav-link"><i class="undefined"></i>
  tool
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/systrace/" class="nav-link"><i class="undefined"></i>
  systrace
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/java/" class="nav-link"><i class="undefined"></i>
  java
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      hz 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/blogs/android/read-source-code/.html" class="nav-link"><i class="undefined"></i>
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/blogs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>android 启动过程源代码分析</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>hz</span>
          
        <!---->
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">android 启动过程源代码分析</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>hz</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2025/11/27</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>android</span><span class="tag-item" data-v-8a445198>源码分析</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="android应用程序启动过程源代码分析"><a href="#android应用程序启动过程源代码分析" class="header-anchor">#</a> Android应用程序启动过程源代码分析</h1> <hr> <p>参考老罗分享的<a href="https://blog.csdn.net/luoshengyang/article/details/6689748" target="_blank" rel="noopener noreferrer">启动过程源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>学习时发现新版有差异，但是核心逻辑没变,后续根据Android API 30分析(参考<a href="https://juejin.cn/post/7502457440443039795" target="_blank" rel="noopener noreferrer">掘金分享<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，查看其他版本可以在
<a href="https://android.googlesource.com/platform/frameworks/base/+refs" target="_blank" rel="noopener noreferrer">官网源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 查看</p> <hr> <h1 id="一、launcher-阶段"><a href="#一、launcher-阶段" class="header-anchor">#</a> 一、Launcher 阶段</h1> <h2 id="step-1-launcher-startactivitysafely"><a href="#step-1-launcher-startactivitysafely" class="header-anchor">#</a> Step 1.Launcher.startActivitySafely</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span>
		<span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">,</span> <span class="token class-name">OnLongClickListener</span><span class="token punctuation">,</span> <span class="token class-name">LauncherModel<span class="token punctuation">.</span>Callbacks</span><span class="token punctuation">,</span> <span class="token class-name">AllAppsView<span class="token punctuation">.</span>Watcher</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Object</span> tag <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token keyword">instanceof</span> <span class="token class-name">ShortcutInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Open shortcut</span>
			<span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ShortcutInfo</span><span class="token punctuation">)</span> tag<span class="token punctuation">)</span><span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
			<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			v<span class="token punctuation">.</span><span class="token function">getLocationOnScreen</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			intent<span class="token punctuation">.</span><span class="token function">setSourceBounds</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span>pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> v<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> v<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">startActivitySafely</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token keyword">instanceof</span> <span class="token class-name">FolderInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> mHandleView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">void</span> <span class="token function">startActivitySafely</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">Object</span> tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ActivityNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>.MainActivity<span class="token punctuation">&quot;</span></span>  
      <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@string/app_name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">&gt;</span></span>  
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.intent.action.MAIN<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>  
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.intent.category.LAUNCHER<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">&gt;</span></span>  
</code></pre></div><h3 id="_1-1分析"><a href="#_1-1分析" class="header-anchor">#</a> 1.1分析</h3> <p>intent包含信息：<br>
1.action = &quot;android.intent.action.Main&quot;
2.category=&quot;android.intent.category.LAUNCHER&quot;
3.cmp=&quot;shy.luo.activity/.MainActivity&quot;<br>
4.Intent.FLAG_ACTIVITY_NEW_TASK<br> <strong>FLAG_ACTIVITY_NEW_TASK</strong>表示要在一个新的<strong>task</strong>中启动这个activity，这里<strong>不是进程</strong><a href="http://developer.android.com/guide/topics/manifest/activity-element.html" target="_blank" rel="noopener noreferrer">task相关资料<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="step-2-activity-startactivity"><a href="#step-2-activity-startactivity" class="header-anchor">#</a> Step 2. Activity.startActivity</h2> <p>Launcher : activity ,实际调用的还是activity中的startActivity</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-1-相关分析"><a href="#_2-1-相关分析" class="header-anchor">#</a> 2.1 相关分析</h3> <p>startActivity 实际都是调用的startActivityForResult，第二个参数传入-1表示不需要这个Actvity结束后的返回结果。</p> <h2 id="step-3-activity-startactivityforresult"><a href="#step-3-activity-startactivityforresult" class="header-anchor">#</a> Step 3. Activity.startActivityForResult</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options <span class="token operator">=</span> <span class="token function">transferSpringboardActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Instrumentation<span class="token punctuation">.</span>ActivityResult</span> ar <span class="token operator">=</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ActivityThread里面调用</span>
            mMainThread<span class="token punctuation">.</span><span class="token function">sendActivityResult</span><span class="token punctuation">(</span>
                mToken<span class="token punctuation">,</span> mEmbeddedID<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> ar<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                ar<span class="token punctuation">.</span><span class="token function">getResultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//需要结果时可以在onCreate或onResume中设置，作用：保存隐藏，避免闪烁</span>
            mStartedActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//取消待处理的输入，如果要运行活动转换</span>
        <span class="token function">cancelInputsAndStartExitTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-相关分析"><a href="#_3-1-相关分析" class="header-anchor">#</a> 3.1 相关分析</h3> <ol><li>启动流程中主要关注<strong>mInstrumentation.execStartActivity</strong>，Instrumentation、ActivityThread等都是在activity.<strong>attach</strong>中接收的，具体初始化后续再分析。</li> <li>Instrumentation：用来监控应用程序和系统的交互，mMainThread 就是ActivityThread实例，mToken是Binder对象的远程接口。</li> <li>这里通过<strong>mMainThread.getApplicationThread</strong>获取ApplicationThread，是一个Binder对象，后面我们会看到，ActivityManagerService会使用它来和ActivityThread来进行进程间通信。这里我们需注意的是，这里的mMainThread代表的是Launcher应用程序运行的进程。</li></ol> <h2 id="step-4-instrumentation-execstartactivity"><a href="#step-4-instrumentation-execstartactivity" class="header-anchor">#</a> Step 4. <strong>Instrumentation.execStartActivity</strong></h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
	<span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
	<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//在真正启动目标 Activity 前，通过注册的 ActivityMonitor（Activity 监控器）拦截启动请求，  </span>
            <span class="token comment">//根据监控器规则返回预设结果或放行，实现对 Activity 启动的监听、拦截和模拟响应。</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
	        intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                        intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        token<span class="token punctuation">,</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                        requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//ActivityManager class</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IActivityTaskManager</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">IActivityTaskManagerSingleton</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@UnsupportedAppUsage</span><span class="token punctuation">(</span>trackingBug <span class="token operator">=</span> <span class="token number">129726065</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IActivityTaskManagerSingleton</span> <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">IActivityTaskManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_TASK_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-1-相关分析"><a href="#_4-1-相关分析" class="header-anchor">#</a> 4.1 相关分析</h3> <p><strong>ActivityTaskManager.getService()<strong>返回</strong>ActivityTaskManagerService</strong>的远程接口。<br>
基于 Binder 机制,<strong>本质是通过 Binder 代理转发给 ATMS 真身</strong>；</p> <h1 id="二、ams-处理阶段"><a href="#二、ams-处理阶段" class="header-anchor">#</a> 二、AMS 处理阶段</h1> <h2 id="step-5-activitytaskmanagerservice-startactivity"><a href="#step-5-activitytaskmanagerservice-startactivity" class="header-anchor">#</a> Step 5. ActivityTaskManagerService.startActivity</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//System service for managing activities and their containers (task, stacks, displays,... )</span>
<span class="token comment">//用于管理活动及其容器(任务、堆栈、显示等)的系统服务。</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span>
            <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span>
            <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span>
                <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span>
            <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span>
            <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                <span class="token boolean">true</span> <span class="token comment">/*validateIncomingUser*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
            <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
            <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> validateIncomingUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//权限与包名校验</span>
        <span class="token function">assertPackageMatchesCallingUid</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断调用者进程是否被隔离</span>
        <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">&quot;startActivityAsUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//用户身份校验与确认(多用户场景核心）</span>
        userId <span class="token operator">=</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkTargetUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> validateIncomingUser<span class="token punctuation">,</span>
                <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;startActivityAsUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//切换到用户应用堆栈:</span>
        <span class="token keyword">return</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">&quot;startActivityAsUser&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span>                <span class="token comment">// 发起方的 IApplicationThread（Binder 代理，用于回调结果）</span>
            <span class="token punctuation">.</span><span class="token function">setCallingPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token comment">// 发起方包名（用于权限校验、日志）</span>
            <span class="token punctuation">.</span><span class="token function">setCallingFeatureId</span><span class="token punctuation">(</span>callingFeatureId<span class="token punctuation">)</span><span class="token comment">// 发起方的 Feature ID（Android 9+ 新增，用于模块化App）</span>
            <span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span>    <span class="token comment">// Intent 的 MIME 类型（比如 &quot;image/*&quot;，从 intent.resolveTypeIfNeeded 得到）</span>
            <span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span>            <span class="token comment">// 接收返回结果的 Activity 的 Binder token（比如 startActivityForResult 时用到）</span>
            <span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span>          <span class="token comment">// 接收结果的 &quot;who&quot; 标识（配合 requestCode 使用）</span>
            <span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span>      <span class="token comment">// 启动请求码（startActivityForResult 时的请求码，-1 表示不需要结果）</span>
            <span class="token punctuation">.</span><span class="token function">setStartFlags</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span>        <span class="token comment">// 启动标志（比如 FLAG_ACTIVITY_NEW_TASK、FLAG_ACTIVITY_CLEAR_TOP 等）</span>
            <span class="token punctuation">.</span><span class="token function">setProfilerInfo</span><span class="token punctuation">(</span>profilerInfo<span class="token punctuation">)</span>    <span class="token comment">// 性能分析相关信息（非必要，可为 null）</span>
            <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>bOptions<span class="token punctuation">)</span>     <span class="token comment">// 启动配置（比如动画、栈模式、分屏等，对应上层的 ActivityOptions）</span>
            <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>                <span class="token comment">// 最终确认的目标用户 ID</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// 执行启动流程</span>

    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token class-name">String</span> caller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">isIsolated</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">&quot;Isolated process not allowed to call &quot;</span> <span class="token operator">+</span> caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_5-1分析"><a href="#_5-1分析" class="header-anchor">#</a> 5.1分析</h3> <ol><li>最终会调用startActivityAsUser ,<strong>ActivityStartController</strong></li> <li>ActivityTaskManagerService 用于管理活动及其容器(任务、堆栈、显示等)的系统服务。</li> <li>startActivityAsUser 是 ATMS 中承接跨进程启动请求、初始化启动参数并转交核心控制器处理的关键方法—— 它不直接执行启动逻辑，而是做 “参数校验、用户身份确认、启动参数封装”，<strong>最终把请求交给ActivityStartController</strong></li> <li><strong>ActivityStarter</strong> 是启动 Activity 的控制类，根据设置的参数来决定如何根据 Intent 和 Flags 来启动 Activity，并将 Activity 和 Task 以及 Stack 相关联。它在调用 ActivityStarter 的 execute 方法之前一直有效。</li> <li>调用者进程如果被隔离或者无权限会抛出 SecurityException 异常。最后调用 ActivityStartController 的 obtainStarter 方法获取一个 ActivityStarter 对象。</li></ol> <p>我们先看 ActivityStartController 的核心逻辑：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityStartController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ActivityTaskManagerService</span> mService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ActivityStackSupervisor</span> mSupervisor<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ActivityStarter</span> mLastStarter<span class="token punctuation">;</span>
    <span class="token class-name">ActivityStarter</span> <span class="token function">obtainStarter</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mFactory<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>mFactory.obtain() 在ActivityStarter 中返回<strong>ActivityStarter</strong> 最终调用的ActivityStarter.execute()</p> <h2 id="step-6-activitystarter-execute"><a href="#step-6-activitystarter-execute" class="header-anchor">#</a> Step 6. ActivityStarter.execute</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    res <span class="token operator">=</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">ActivityRecord</span> sourceRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ActivityRecord</span> resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sourceRecord <span class="token operator">=</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">isInAnyStack</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sourceRecord<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLastStartActivityResult <span class="token operator">=</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span>
        request<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* doResume */</span><span class="token punctuation">,</span> checkedOptions<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span>
        restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> mLastStartActivityResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_6-1-分析"><a href="#_6-1-分析" class="header-anchor">#</a> 6.1 分析</h3> <ol><li>execute 里面调用 executeRequest</li> <li>executeRequest 执行 Activity 启动请求，这里首先执几项初步检查，并创建了 ActivityRecord：</li> <li>ActivityRecord 用于维护一个 Activity 的相关信息，如任务栈、生命周期等。</li></ol> <h2 id="step-7-activitystarter-startactivityunchecked"><a href="#step-7-activitystarter-startactivityunchecked" class="header-anchor">#</a> Step 7. ActivityStarter.startActivityUnchecked</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
            <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
            <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token constant">START_CANCELED</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> startedActivityStack<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        mService<span class="token punctuation">.</span><span class="token function">deferWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;startActivityInner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        startedActivityStack <span class="token operator">=</span> <span class="token function">handleStartResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">continueWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">postStartActivityProcessing</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">,</span> startedActivityStack<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-1-分析"><a href="#_7-1-分析" class="header-anchor">#</a> 7.1 分析</h3> <p>startActivityUnchecked 在完成大部分初步检查并确认调用方拥有执行此操作的必要权限时启动 Activity，还确保在启动不成功时删除正在启动的 Activity:</p> <h2 id="step-8-startactivityinner"><a href="#step-8-startactivityinner" class="header-anchor">#</a> Step 8. startActivityInner</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
        <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
        <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
        <span class="token class-name">TaskFragment</span> inTaskFragment<span class="token punctuation">,</span> <span class="token class-name">BalVerdict</span> balVerdict<span class="token punctuation">,</span>
        <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">,</span> <span class="token keyword">int</span> realCallingUid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setInitialState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> inTaskFragment<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span>
            voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span> balVerdict<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realCallingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>···<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Flag 为 FLAG_ACTIVITY_NEW_TASK，根据 computeTargetTask 计算需要返回 null，表示需要新的 Task</span>
    <span class="token keyword">final</span> <span class="token class-name">Task</span> targetTask <span class="token operator">=</span> reusedTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> reusedTask <span class="token operator">:</span> <span class="token function">computeTargetTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newTask <span class="token operator">=</span> targetTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// true</span>
    mTargetTask <span class="token operator">=</span> targetTask<span class="token punctuation">;</span>
    <span class="token function">computeLaunchParams</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> targetTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Task 为 null，创建新的 ActivityRecord 为 null</span>
    <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> targetTaskTop <span class="token operator">=</span> newTask
            <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> targetTask<span class="token punctuation">.</span><span class="token function">getTopNonFinishingActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetTaskTop <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetRootTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 Task</span>
        mTargetRootTask <span class="token operator">=</span> <span class="token function">getOrCreateRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> targetTask<span class="token punctuation">,</span>
                mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> taskToAffiliate <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> mSourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 将 ActivityRecord 与 Task 关联</span>
        <span class="token function">setNewTask</span><span class="token punctuation">(</span>taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAvoidMoveToFront <span class="token operator">&amp;&amp;</span> mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logOnlyCreatorAllowsBAL</span><span class="token punctuation">(</span>balVerdict<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 移动到栈顶</span>
        mTargetRootTask<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">&quot;reuseOrNewTask&quot;</span><span class="token punctuation">,</span> targetTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityRecord</span> topTaskActivity <span class="token operator">=</span> startedTask<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTargetRootTask<span class="token punctuation">.</span><span class="token function">isTopActivityFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// Activity resume</span>
            mRootWindowContainer<span class="token punctuation">.</span><span class="token function">resumeFocusedTasksTopActivities</span><span class="token punctuation">(</span>
                    mTargetRootTask<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> mTransientLaunch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    mRootWindowContainer<span class="token punctuation">.</span><span class="token function">updateUserRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span> mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当活动开始时，立即更新最近任务列表</span>
    mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>startedTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSupervisor<span class="token punctuation">.</span><span class="token function">handleNonResizableTaskIfNeeded</span><span class="token punctuation">(</span>startedTask<span class="token punctuation">,</span>
            mPreferredWindowingMode<span class="token punctuation">,</span> mPreferredTaskDisplayArea<span class="token punctuation">,</span> mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 Activity 正在启动进入画中画模式，则立即将 mStartActivity 移动到固定模式。</span>
    <span class="token comment">// 请注意，此时 mStartActivity 和源 Activity 应处于同一任务中。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mOptions<span class="token punctuation">.</span><span class="token function">isLaunchIntoPip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> balVerdict<span class="token punctuation">.</span><span class="token function">allows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mRootWindowContainer<span class="token punctuation">.</span><span class="token function">moveActivityToPinnedRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span>
                sourceRecord<span class="token punctuation">,</span> <span class="token string">&quot;launch-into-pip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mSupervisor<span class="token punctuation">.</span><span class="token function">getBackgroundActivityLaunchController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">onNewActivityLaunched</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_8-1-分析"><a href="#_8-1-分析" class="header-anchor">#</a> 8.1 分析</h3> <ol><li>startActivityInner 启动 Activity 并确定该 Activity 是否应添加到已经存在的 task 的顶部或向现有 activity 传递新 Intent</li> <li>startActivityInner 首先创建了 Task，接着将 ActivityRecord 挂载到创建的 Task 下，并移动 Task 到栈顶，最后调用 RootWindowContainer resumeFocusedTasksTopActivities 方法显示顶部的 Activity</li> <li>RootWindowContainer 是窗口管理树的根节点，负责管理整个系统中所有窗口的层级关系和布局，以及处理窗口的生命周期和多屏幕支持。</li></ol> <h2 id="step-9-rootwindowcontainer-resumefocusedstackstopactivities"><a href="#step-9-rootwindowcontainer-resumefocusedstackstopactivities" class="header-anchor">#</a> Step 9. RootWindowContainer.resumeFocusedStacksTopActivities</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">resumeFocusedTasksTopActivities</span><span class="token punctuation">(</span>
        <span class="token class-name">Task</span> targetRootTask<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> target<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> targetOptions<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> deferPause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTaskSupervisor<span class="token punctuation">.</span><span class="token function">readyToResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetRootTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>targetRootTask<span class="token punctuation">.</span><span class="token function">isTopRootTaskInDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">getTopDisplayFocusedRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> targetRootTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// targetRootTask 就是刚创建的目标 Task</span>
        result <span class="token operator">=</span> targetRootTask<span class="token punctuation">.</span><span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetOptions<span class="token punctuation">,</span>
                deferPause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> display <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> curResult <span class="token operator">=</span> result<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resumedOnDisplay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        display<span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>rootTask <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> topRunningActivity <span class="token operator">=</span> rootTask<span class="token punctuation">.</span><span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootTask<span class="token punctuation">.</span><span class="token function">isFocusableAndVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> topRunningActivity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rootTask <span class="token operator">==</span> targetRootTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resumedOnDisplay<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> curResult<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>topRunningActivity<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span><span class="token constant">RESUMED</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> topRunningActivity <span class="token operator">==</span> rootTask<span class="token punctuation">.</span><span class="token function">getDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rootTask<span class="token punctuation">.</span><span class="token function">executeAppTransition</span><span class="token punctuation">(</span>targetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                resumedOnDisplay<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> topRunningActivity<span class="token punctuation">.</span><span class="token function">makeActiveIfNeeded</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">|=</span> resumedOnDisplay<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resumedOnDisplay<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>Task</span> focusedRoot <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getFocusedRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>focusedRoot <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">|=</span> focusedRoot<span class="token punctuation">.</span><span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>targetRootTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">|=</span> <span class="token function">resumeHomeActivity</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* prev */</span><span class="token punctuation">,</span> <span class="token string">&quot;no-focusable-task&quot;</span><span class="token punctuation">,</span>
                        display<span class="token punctuation">.</span><span class="token function">getDefaultTaskDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>RootWindowContainer 是窗口管理树的根节点，负责管理整个系统中所有窗口的层级关系和布局，以及处理窗口的生命周期和多屏幕支持。
看一下 RootWindowContainer 的 resumeFocusedTasksTopActivities，是实现 Activity 显示和切换的关键方法：</p> <h2 id="step-10-activitystack-resumefocusedtaskstopactivities"><a href="#step-10-activitystack-resumefocusedtaskstopactivities" class="header-anchor">#</a> Step 10.ActivityStack.resumeFocusedTasksTopActivities</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> prev<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInResumeTopActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// 别去尝试递归操作了。</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 防止递归。</span>
            mInResumeTopActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 当重新启动最顶层的活动时，可能需要暂停最顶层的活动（例如返回锁屏界面。我们在 {@link #resumeTopActivityUncheckedLocked}   </span>
            <span class="token comment">// 中抑制了常规的暂停逻辑，因为最顶层的活动会在结束时重新启动。我们在这里再次调用   </span>
            <span class="token comment">// {@link ActivityStackSupervisor#checkReadyForSleepLocked} 以确保任何必要的暂停逻辑得以执行。  </span>
            <span class="token comment">// 如果该活动无论是否处于锁屏状态都会显示出来，那么就不会调用   </span>
            <span class="token comment">// {@link ActivityStackSupervisor#checkReadyForSleepLocked} 。</span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> next <span class="token operator">=</span> <span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* focusableOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>next<span class="token punctuation">.</span><span class="token function">canTurnScreenOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkReadyForSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mInResumeTopActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h2 id="step-11-activitystack-resumetopactivityinnerlocked"><a href="#step-11-activitystack-resumetopactivityinnerlocked" class="header-anchor">#</a> Step 11. ActivityStack.resumeTopActivityInnerLocked</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> prev<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAtmService<span class="token punctuation">.</span><span class="token function">isBooting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAtmService<span class="token punctuation">.</span><span class="token function">isBooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Not ready yet!</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Find the next top-most activity to resume in this stack that is not finishing and is</span>
        <span class="token comment">// focusable. If it is not focusable, we will fall into the case below to resume the</span>
        <span class="token comment">// top activity in the next focusable task.</span>
        <span class="token class-name">ActivityRecord</span> next <span class="token operator">=</span> <span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* focusableOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasRunningActivity <span class="token operator">=</span> next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// TODO: Maybe this entire condition can get removed?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasRunningActivity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mRootWindowContainer<span class="token punctuation">.</span><span class="token function">cancelInitializingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Remember how we'll process this pause/resume situation, and ensure</span>
        <span class="token comment">// that the state is reset however we wind up proceeding.</span>
        <span class="token keyword">boolean</span> userLeaving <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span>mUserLeaving<span class="token punctuation">;</span>
        mStackSupervisor<span class="token punctuation">.</span>mUserLeaving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasRunningActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// There are no activities left in the stack, let's look somewhere else.</span>
            <span class="token keyword">return</span> <span class="token function">resumeNextFocusableActivityWhenStackIsEmpty</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        next<span class="token punctuation">.</span>delayedResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">TaskDisplayArea</span> taskDisplayArea <span class="token operator">=</span> <span class="token function">getDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If the top activity is the resumed one, nothing to do.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">==</span> next <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span><span class="token constant">RESUMED</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">allResumedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Make sure we have executed any pending transitions, since there</span>
            <span class="token comment">// should be nothing left to do at this point.</span>
            <span class="token function">executeAppTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;resumeTopActivityLocked: Top activity resumed &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span><span class="token function">canResumeByCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If we are currently pausing an activity, then don't do anything until that is done.</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> allPausedComplete <span class="token operator">=</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allPausedComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span> <span class="token operator">||</span> <span class="token constant">DEBUG_PAUSE</span> <span class="token operator">||</span> <span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_PAUSE</span><span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityLocked: Skip resume: some activity pausing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If we are sleeping, and there is no resumed activity, and the top activity is paused,</span>
        <span class="token comment">// well that is the state we want.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSleepOrShutDownActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> mLastPausedActivity <span class="token operator">==</span> next
                <span class="token operator">&amp;&amp;</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If the current top activity may be able to occlude keyguard but the occluded state</span>
            <span class="token comment">// has not been set, update visibility and check again if we should continue to resume.</span>
            <span class="token keyword">boolean</span> nothingToResume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAtmService<span class="token punctuation">.</span>mShuttingDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> canShowWhenLocked <span class="token operator">=</span> <span class="token operator">!</span>mTopActivityOccludesKeyguard
                        <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span><span class="token function">canShowWhenLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> mayDismissKeyguard <span class="token operator">=</span> mTopDismissingKeyguardActivity <span class="token operator">!=</span> next
                        <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span><span class="token function">containsDismissKeyguardWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>canShowWhenLocked <span class="token operator">||</span> mayDismissKeyguard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* starting */</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* configChanges */</span><span class="token punctuation">,</span>
                            <span class="token operator">!</span><span class="token constant">PRESERVE_WINDOWS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nothingToResume <span class="token operator">=</span> <span class="token function">shouldSleepActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">currentLaunchCanTurnScreenOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span><span class="token function">canTurnScreenOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nothingToResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nothingToResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Make sure we have executed any pending transitions, since there</span>
                <span class="token comment">// should be nothing left to do at this point.</span>
                <span class="token function">executeAppTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;resumeTopActivityLocked: Going to sleep and all paused&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Make sure that the user who owns this activity is started.  If not,</span>
        <span class="token comment">// we will just leave it as is because someone should be bringing</span>
        <span class="token comment">// another user's activities to the top of the stack.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAtmService<span class="token punctuation">.</span>mAmInternal<span class="token punctuation">.</span><span class="token function">hasStartedUserState</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>mUserId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Skipping resume of top activity &quot;</span> <span class="token operator">+</span> next
                    <span class="token operator">+</span> <span class="token string">&quot;: user &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>mUserId <span class="token operator">+</span> <span class="token string">&quot; is stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// The activity may be waiting for stop, but that is no longer</span>
        <span class="token comment">// appropriate for it.</span>
        mStackSupervisor<span class="token punctuation">.</span>mStoppingActivities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        next<span class="token punctuation">.</span><span class="token function">setSleeping</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SWITCH</span><span class="token punctuation">,</span> <span class="token string">&quot;Resuming &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If we are currently pausing an activity, then don't do anything until that is done.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRootWindowContainer<span class="token punctuation">.</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span> <span class="token operator">||</span> <span class="token constant">DEBUG_PAUSE</span> <span class="token operator">||</span> <span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_PAUSE</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;resumeTopActivityLocked: Skip resume: some activity pausing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mStackSupervisor<span class="token punctuation">.</span><span class="token function">setLaunchSource</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ActivityRecord</span> lastResumed <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> lastFocusedStack <span class="token operator">=</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">getLastFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastFocusedStack <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> lastFocusedStack <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// So, why aren't we using prev here??? See the param comment on the method. prev doesn't</span>
            <span class="token comment">// represent the last resumed activity. However, the last focus stack does if it isn't null.</span>
            lastResumed <span class="token operator">=</span> lastFocusedStack<span class="token punctuation">.</span>mResumedActivity<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userLeaving <span class="token operator">&amp;&amp;</span> <span class="token function">inMultiWindowMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastFocusedStack<span class="token punctuation">.</span><span class="token function">shouldBeVisible</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// The user isn't leaving if this stack is the multi-window mode and the last</span>
                <span class="token comment">// focused stack should still be visible.</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">DEBUG_USER_LEAVING</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG_USER_LEAVING</span><span class="token punctuation">,</span> <span class="token string">&quot;Overriding userLeaving to false&quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot; next=&quot;</span> <span class="token operator">+</span> next <span class="token operator">+</span> <span class="token string">&quot; lastResumed=&quot;</span> <span class="token operator">+</span> lastResumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                userLeaving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> pausing <span class="token operator">=</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">pauseBackStacks</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;resumeTopActivityLocked: Pausing &quot;</span> <span class="token operator">+</span> mResumedActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pausing <span class="token operator">|=</span> <span class="token function">startPausingLocked</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* uiSleeping */</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pausing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span> <span class="token operator">||</span> <span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;resumeTopActivityLocked: Skip resume: need to start pausing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// At this point we want to put the upcoming activity's process</span>
            <span class="token comment">// at the top of the LRU list, since we know we will be needing it</span>
            <span class="token comment">// very soon and it would be a waste to let it get killed if it</span>
            <span class="token comment">// happens to be sitting towards the end.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">attachedToProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">updateProcessInfo</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment">/* updateServiceConnectionActivities */</span><span class="token punctuation">,</span>
                        <span class="token boolean">true</span> <span class="token comment">/* activityChange */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* updateOomAdj */</span><span class="token punctuation">,</span>
                        <span class="token boolean">false</span> <span class="token comment">/* addPendingTopUid */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span><span class="token function">isProcessRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Since the start-process is asynchronous, if we already know the process of next</span>
                <span class="token comment">// activity isn't running, we can start the process earlier to save the time to wait</span>
                <span class="token comment">// for the current activity to be paused.</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTop <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token operator">==</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAtmService<span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* knownToBeDead */</span><span class="token punctuation">,</span> isTop<span class="token punctuation">,</span>
                        isTop <span class="token operator">?</span> <span class="token string">&quot;pre-top-activity&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;pre-activity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastResumed <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lastResumed<span class="token punctuation">.</span><span class="token function">setWillCloseOrEnterPip</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">==</span> next <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span><span class="token function">isState</span><span class="token punctuation">(</span><span class="token constant">RESUMED</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">allResumedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// It is possible for the activity to be resumed when we paused back stacks above if the</span>
            <span class="token comment">// next activity doesn't have to wait for pause to complete.</span>
            <span class="token comment">// So, nothing else to-do except:</span>
            <span class="token comment">// Make sure we have executed any pending transitions, since there</span>
            <span class="token comment">// should be nothing left to do at this point.</span>
            <span class="token function">executeAppTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;resumeTopActivityLocked: Top activity resumed (dontWaitForPause) &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the most recent activity was noHistory but was only stopped rather</span>
        <span class="token comment">// than stopped+finished because the device went to sleep, we need to make</span>
        <span class="token comment">// sure to finish it as we're making a new activity topmost.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSleepActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mLastNoHistoryActivity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>mLastNoHistoryActivity<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;no-history finish of &quot;</span> <span class="token operator">+</span> mLastNoHistoryActivity <span class="token operator">+</span> <span class="token string">&quot; on new resume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLastNoHistoryActivity<span class="token punctuation">.</span><span class="token function">finishIfPossible</span><span class="token punctuation">(</span><span class="token string">&quot;resume-no-history&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* oomAdj */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLastNoHistoryActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!=</span> next <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// The next activity is already visible, so hide the previous</span>
            <span class="token comment">// activity's windows right now so we can show the new one ASAP.</span>
            <span class="token comment">// We only do this if the previous is finishing, which should mean</span>
            <span class="token comment">// it is on top of the one being resumed so hiding it quickly</span>
            <span class="token comment">// is good.  Otherwise, we want to do the normal route of allowing</span>
            <span class="token comment">// the resumed activity to be shown so we can decide if the</span>
            <span class="token comment">// previous should actually be hidden depending on whether the</span>
            <span class="token comment">// new one is found to be full-screen or not.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SWITCH</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Not waiting for visible to hide: &quot;</span> <span class="token operator">+</span> prev
                        <span class="token operator">+</span> <span class="token string">&quot;, nowVisible=&quot;</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SWITCH</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Previous already visible but still waiting to hide: &quot;</span> <span class="token operator">+</span> prev
                        <span class="token operator">+</span> <span class="token string">&quot;, nowVisible=&quot;</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token comment">// Launching this app's activity, make sure the app is no longer</span>
        <span class="token comment">// considered stopped.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mAtmService<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPackageStoppedState</span><span class="token punctuation">(</span>
                    next<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span>mUserId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* TODO: Verify if correct userid */</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed trying to unstop package &quot;</span>
                    <span class="token operator">+</span> next<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We are starting up the next activity, so tell the window manager</span>
        <span class="token comment">// that the previous one will be hidden soon.  This way it can know</span>
        <span class="token comment">// to ignore it when computing the desired screen orientation.</span>
        <span class="token keyword">boolean</span> anim <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> dc <span class="token operator">=</span> taskDisplayArea<span class="token punctuation">.</span>mDisplayContent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_TRANSITION</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_TRANSITION</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Prepare close transition: prev=&quot;</span> <span class="token operator">+</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    anim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    dc<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span><span class="token constant">TRANSIT_NONE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    dc<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>
                            prev<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> next<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">TRANSIT_ACTIVITY_CLOSE</span>
                                    <span class="token operator">:</span> <span class="token constant">TRANSIT_TASK_CLOSE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                prev<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_TRANSITION</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_TRANSITION</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Prepare open transition: prev=&quot;</span> <span class="token operator">+</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    anim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    dc<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span><span class="token constant">TRANSIT_NONE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    dc<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>
                            prev<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> next<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">TRANSIT_ACTIVITY_OPEN</span>
                                    <span class="token operator">:</span> next<span class="token punctuation">.</span>mLaunchTaskBehind <span class="token operator">?</span> <span class="token constant">TRANSIT_TASK_OPEN_BEHIND</span>
                                            <span class="token operator">:</span> <span class="token constant">TRANSIT_TASK_OPEN</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_TRANSITION</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_TRANSITION</span><span class="token punctuation">,</span> <span class="token string">&quot;Prepare open transition: no previous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                anim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                dc<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span><span class="token constant">TRANSIT_NONE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                dc<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span><span class="token constant">TRANSIT_ACTIVITY_OPEN</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>anim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">applyOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">clearOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mStackSupervisor<span class="token punctuation">.</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">attachedToProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SWITCH</span><span class="token punctuation">,</span> <span class="token string">&quot;Resume running: &quot;</span> <span class="token operator">+</span> next
                    <span class="token operator">+</span> <span class="token string">&quot; stopped=&quot;</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>stopped
                    <span class="token operator">+</span> <span class="token string">&quot; visibleRequested=&quot;</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>mVisibleRequested<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// If the previous activity is translucent, force a visibility update of</span>
            <span class="token comment">// the next activity, so that it's added to WM's opening app list, and</span>
            <span class="token comment">// transition animation can be set up properly.</span>
            <span class="token comment">// For example, pressing Home button with a translucent activity in focus.</span>
            <span class="token comment">// Launcher is already visible in this case. If we don't add it to opening</span>
            <span class="token comment">// apps, maybeUpdateTransitToWallpaper() will fail to identify this as a</span>
            <span class="token comment">// TRANSIT_WALLPAPER_OPEN animation, and run some funny animation.</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> lastActivityTranslucent <span class="token operator">=</span> lastFocusedStack <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lastFocusedStack<span class="token punctuation">.</span><span class="token function">inMultiWindowMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>lastFocusedStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lastFocusedStack<span class="token punctuation">.</span>mLastPausedActivity<span class="token punctuation">.</span><span class="token function">occludesParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// This activity is now becoming visible.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>mVisibleRequested <span class="token operator">||</span> next<span class="token punctuation">.</span>stopped <span class="token operator">||</span> lastActivityTranslucent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// schedule launch ticks to collect information about slow apps.</span>
            next<span class="token punctuation">.</span><span class="token function">startLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ActivityRecord</span> lastResumedActivity <span class="token operator">=</span>
                    lastFocusedStack <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> lastFocusedStack<span class="token punctuation">.</span>mResumedActivity<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityState</span> lastState <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mAtmService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span> <span class="token string">&quot;Moving to RESUMED: &quot;</span> <span class="token operator">+</span> next
                    <span class="token operator">+</span> <span class="token string">&quot; (in existing)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            next<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">RESUMED</span><span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityInnerLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">updateProcessInfo</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment">/* updateServiceConnectionActivities */</span><span class="token punctuation">,</span>
                    <span class="token boolean">true</span> <span class="token comment">/* activityChange */</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* updateOomAdj */</span><span class="token punctuation">,</span>
                    <span class="token boolean">true</span> <span class="token comment">/* addPendingTopUid */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Have the window manager re-evaluate the orientation of</span>
            <span class="token comment">// the screen based on the new activity order.</span>
            <span class="token keyword">boolean</span> notUpdated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">// Activity should also be visible if set mLaunchTaskBehind to true (see</span>
            <span class="token comment">// ActivityRecord#shouldBeVisibleIgnoringKeyguard()).</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldBeVisible</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// We have special rotation behavior when here is some active activity that</span>
                <span class="token comment">// requests specific orientation or Keyguard is locked. Make sure all activity</span>
                <span class="token comment">// visibilities are set correctly as well as the transition is updated if needed</span>
                <span class="token comment">// to get the correct rotation behavior. Otherwise the following call to update</span>
                <span class="token comment">// the orientation may cause incorrect configurations delivered to client as a</span>
                <span class="token comment">// result of invisible window resize.</span>
                <span class="token comment">// TODO: Remove this once visibilities are set correctly immediately when</span>
                <span class="token comment">// starting an activity.</span>
                notUpdated <span class="token operator">=</span> <span class="token operator">!</span>mRootWindowContainer<span class="token punctuation">.</span><span class="token function">ensureVisibilityAndConfig</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token boolean">true</span> <span class="token comment">/* markFrozenIfConfigChanged */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* deferResume */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>notUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// The configuration update wasn't able to keep the existing</span>
                <span class="token comment">// instance of the activity, and instead started a new one.</span>
                <span class="token comment">// We should be all done, but let's just make sure our activity</span>
                <span class="token comment">// is still at the top and schedule another run if something</span>
                <span class="token comment">// weird happened.</span>
                <span class="token class-name">ActivityRecord</span> nextNext <span class="token operator">=</span> <span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span> <span class="token operator">||</span> <span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Activity config changed during resume: &quot;</span> <span class="token operator">+</span> next
                                <span class="token operator">+</span> <span class="token string">&quot;, new next: &quot;</span> <span class="token operator">+</span> nextNext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextNext <span class="token operator">!=</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Do over!</span>
                    mStackSupervisor<span class="token punctuation">.</span><span class="token function">scheduleResumeTopActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>mVisibleRequested <span class="token operator">||</span> next<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                next<span class="token punctuation">.</span><span class="token function">completeResumeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> transaction <span class="token operator">=</span>
                        <span class="token class-name">ClientTransaction</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span>appToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Deliver all pending results.</span>
                <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResultInfo</span><span class="token punctuation">&gt;</span></span> a <span class="token operator">=</span> next<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>finishing <span class="token operator">&amp;&amp;</span> <span class="token class-name">N</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESULTS</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_RESULTS</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Delivering results to &quot;</span> <span class="token operator">+</span> next <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        transaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name">ActivityResultItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>newIntents <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    transaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>
                            <span class="token class-name">NewIntentItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>newIntents<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* resume */</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Well the app will no longer be stopped.</span>
                <span class="token comment">// Clear app token stopped state in window manager if needed.</span>
                next<span class="token punctuation">.</span><span class="token function">notifyAppResumed</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>stopped<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token function">writeWmResumeActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        next<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mTaskId<span class="token punctuation">,</span> next<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                next<span class="token punctuation">.</span><span class="token function">setSleeping</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAtmService<span class="token punctuation">.</span><span class="token function">getAppWarningsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onResumeActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">setPendingUiCleanAndForceProcessStateUpTo</span><span class="token punctuation">(</span>mAtmService<span class="token punctuation">.</span>mTopProcessState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">clearOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                transaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>
                        <span class="token class-name">ResumeActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">getReportedProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                dc<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAtmService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityLocked: Resumed &quot;</span>
                        <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Whoops, need to restart this activity!</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span> <span class="token string">&quot;Resume failed; resetting state to &quot;</span>
                        <span class="token operator">+</span> lastState <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>lastState<span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityInnerLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// lastResumedActivity being non-null implies there is a lastStack present.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lastResumedActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lastResumedActivity<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">RESUMED</span><span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityInnerLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Restarting because process died: &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>hasBeenLaunched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span>hasBeenLaunched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SHOW_APP_STARTING_PREVIEW</span> <span class="token operator">&amp;&amp;</span> lastFocusedStack <span class="token operator">!=</span> <span class="token keyword">null</span>
                        <span class="token operator">&amp;&amp;</span> lastFocusedStack<span class="token punctuation">.</span><span class="token function">isTopStackInDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* prev */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* newTask */</span><span class="token punctuation">,</span>
                            <span class="token boolean">false</span> <span class="token comment">/* taskSwitch */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// From this point on, if something goes wrong there is no way</span>
            <span class="token comment">// to recover the activity.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">completeResumeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// If any exception gets thrown, toss away this</span>
                <span class="token comment">// activity and try the next one.</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown during resume of &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">finishIfPossible</span><span class="token punctuation">(</span><span class="token string">&quot;resume-exception&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* oomAdj */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Whoops, need to restart this activity!</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>hasBeenLaunched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span>hasBeenLaunched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SHOW_APP_STARTING_PREVIEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* prev */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* newTask */</span><span class="token punctuation">,</span>
                            <span class="token boolean">false</span> <span class="token comment">/* taskSwich */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SWITCH</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SWITCH</span><span class="token punctuation">,</span> <span class="token string">&quot;Restarting: &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_STATES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG_STATES</span><span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityLocked: Restarting &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_11-1分析"><a href="#_11-1分析" class="header-anchor">#</a> 11.1分析</h3> <ol><li>先对上一个 Activity 执行了 pause 操作，然后判断当前要启动的 Activity 是否已经启动了</li> <li>如果已经启动了，发送 <code>ResumeActivityItem</code> 事务给客户端，执行 resume 流程。</li> <li>如果没有启动，继续调用 <code>ActivityStackSupervisor</code> 的 <code>startSpecificActivity()</code> 方法。</li> <li>这里注意下，调用<code>startSpecificActivity()</code>方法前调用了 <code>next.showStartingWindow()</code> 来展示一个<strong>window</strong>，这就是冷启动时出现<strong>白屏的原因</strong>。</li></ol> <h2 id="step-12-activitystacksupervisor-startspecificactivity"><a href="#step-12-activitystacksupervisor-startspecificactivity" class="header-anchor">#</a> Step 12. ActivityStackSupervisor.startSpecificActivity</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">startSpecificActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Is this activity's application already running?</span>
    <span class="token keyword">final</span> <span class="token class-name">WindowProcessController</span> wpc <span class="token operator">=</span>
            mService<span class="token punctuation">.</span><span class="token function">getProcessController</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> knownToBeDead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wpc <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wpc<span class="token punctuation">.</span><span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> wpc<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception when starting activity &quot;</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If a dead object exception was thrown -- fall through to</span>
        <span class="token comment">// restart the application.</span>
        knownToBeDead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    r<span class="token punctuation">.</span><span class="token function">notifyUnknownVisibilityLaunchedForKeyguardTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTop <span class="token operator">=</span> andResume <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">isTopRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mService<span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> isTop<span class="token punctuation">,</span> isTop <span class="token operator">?</span> <span class="token string">&quot;top-activity&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;activity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-1-分析"><a href="#_12-1-分析" class="header-anchor">#</a> 12.1 分析</h3> <p>里面调用了 (ATMS) ActivityTaskManagerService.startProcessAsync
startSpecificActivity() 方法中通过 wpc.hasThread() 来判断 activity 所在的应用是否已经在运行，其内部是通过 IApplicationThread 是否已经被赋值来判断的，如果为 true，走 ActivityStackSupervisor 的realStartActivityLocked() 方法，即普通 Activity 的启动流程；否则需要调用 ATMS 的 startProcessAsync() 来创建应用进程。</p> <h2 id="step-13-activitytaskmanagerservice-startprocessasync"><a href="#step-13-activitytaskmanagerservice-startprocessasync" class="header-anchor">#</a> Step   13.ActivityTaskManagerService.startProcessAsync</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">startProcessAsync</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> activity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span>
        <span class="token class-name">String</span> hostingType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;dispatchingStartProcess:&quot;</span>
                    <span class="token operator">+</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Post message to start process to avoid possible deadlock of calling into AMS with the</span>
        <span class="token comment">// ATMS lock held.</span>
        <span class="token keyword">final</span> <span class="token class-name">Message</span> m <span class="token operator">=</span> <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerInternal</span><span class="token operator">::</span><span class="token function">startProcess</span><span class="token punctuation">,</span>
                mAmInternal<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span>
                isTop<span class="token punctuation">,</span> hostingType<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>此时应用进程还不存在，需要调用 ATMS 的 startProcessAsync() 来创建应用进程：
这里使用Handler发送消息来启动进程，获取Message对象跟我们平时的使用方式不太一样，这里用到PooledLambda的obtainMessage()方法，实际就是调用了ActivityManagerInternal的startProcess()方法。</p> <h2 id=""><a href="#" class="header-anchor">#</a></h2> <p>ActivityManagerInternal是一个抽象类，它是ActivityManager本地系统服务接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerInternal</span> <span class="token punctuation">{</span>
    <span class="token comment">/** Starts a given process. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span> <span class="token class-name">String</span> hostingType<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> hostingName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ActivityManagerInternal的实现类为AMS的内部类LocalService，这样就把创建进程的请求传递给了AMS去处理。</p> <p>LocalServices可以理解为是一个公开缓存池，内部使用ArrayMap来存储本地服务对象。SystemServer进程中每个服务都可以通过LocalServices的addService()方法注册到LocalServices中，需要使用时通过LocalServices的getService()获取注册的本地服务</p> <h1 id="三、应用程序进程启动阶段"><a href="#三、应用程序进程启动阶段" class="header-anchor">#</a> 三、应用程序进程启动阶段</h1> <h2 id="step-14-ams-localservice-startprocess"><a href="#step-14-ams-localservice-startprocess" class="header-anchor">#</a> Step 14 AMS.LocalService.startProcess</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span> <span class="token class-name">String</span> hostingType<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> hostingName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;startProcess:&quot;</span>
                    <span class="token operator">+</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* intentFlags */</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span>hostingType<span class="token punctuation">,</span> hostingName<span class="token punctuation">,</span> isTop<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token constant">ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* allowWhileBooting */</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment">/* isolated */</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* keepIfLarge */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着会调用 startProcessLocked 方法：</p> <h2 id="step-15-ams-startprocesslocked"><a href="#step-15-ams-startprocesslocked" class="header-anchor">#</a> Step 15 AMS.startProcessLocked</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span>
        <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span>
        <span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowWhileBooting<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> isolated<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepIfLarge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> intentFlags<span class="token punctuation">,</span>
            hostingRecord<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> allowWhileBooting<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* isolatedUid */</span><span class="token punctuation">,</span>
            keepIfLarge<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* ABI override */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* entryPoint */</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span> <span class="token comment">/* entryPointArgs */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* crashHandler */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着调用 ProcessList 的 startProcessLocked 方法，进程启动成功会返回 true</p> <h2 id="step-16-processlist-startprocesslocked"><a href="#step-16-processlist-startprocesslocked" class="header-anchor">#</a> Step 16 ProcessList.startProcessLocked</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span>
        <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disableHiddenApiChecks<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disableTestApiChecks<span class="token punctuation">,</span>
        <span class="token class-name">String</span> abiOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// ProcessRecord 是一个描述进程的数据结构，记录着当前运行的进程的详细信息。</span>
        <span class="token comment">// 获取要创建的应用程序进程的用户ID</span>
        <span class="token keyword">int</span> uid <span class="token operator">=</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> mountExternal <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">MOUNT_EXTERNAL_NONE</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> externalStorageAccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 创建用户组 ID 并赋值</span>
            gids <span class="token operator">=</span> <span class="token function">computeGidsForProcess</span><span class="token punctuation">(</span>mountExternal<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> permGids<span class="token punctuation">,</span> externalStorageAccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 应用程序进程主线程类名</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> entryPoint <span class="token operator">=</span> <span class="token string">&quot;android.app.ActivityThread&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>hostingRecord<span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> app<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                runtimeFlags<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span>
                instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span> <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span>
        <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
        <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
        <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mConstants<span class="token punctuation">.</span><span class="token constant">FLAG_PROCESS_START_ASYNC</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 启动应用程序进程</span>
            <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> startResult <span class="token operator">=</span> <span class="token function">startProcess</span><span class="token punctuation">(</span>hostingRecord<span class="token punctuation">,</span>
                    entryPoint<span class="token punctuation">,</span> app<span class="token punctuation">,</span>
                    uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                    requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">handleProcessStartedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> startResult<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> startResult<span class="token punctuation">.</span>usingWrapper<span class="token punctuation">,</span>
                    startSeq<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Failure starting process &quot;</span>
                    <span class="token operator">+</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">setPendingStart</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">forceStopPackageLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token string">&quot;start failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>ProcessRecord 是一个描述进程的数据结构，记录着当前运行的进程的详细信息。</p> <h2 id="step-17-processlist-startprocess"><a href="#step-17-processlist-startprocess" class="header-anchor">#</a> Step 17 ProcessList.startProcess</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span>
        <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
        <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
        <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span> <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> startResult<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> regularZygote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hostingRecord<span class="token punctuation">.</span><span class="token function">usesWebviewZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hostingRecord<span class="token punctuation">.</span><span class="token function">usesAppZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            regularZygote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用 Process 的 start 方法</span>
            startResult <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span>
                    isTopApp<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pkgDataInfoMap<span class="token punctuation">,</span>
                    allowlistedAppDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token constant">PROC_START_SEQ_IDENT</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getStartSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> startResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="step-18-process-start"><a href="#step-18-process-start" class="header-anchor">#</a> Step 18 Process.start</h2> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessStartResult</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                   pkgDataInfoMap<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                   whitelistedDataInfoMap<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zygoteArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">ZYGOTE_PROCESS</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>processClass<span class="token punctuation">,</span> niceName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                    runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                    abi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> appDataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span>
                    zygotePolicyFlags<span class="token punctuation">,</span> isTopApp<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span>
                    pkgDataInfoMap<span class="token punctuation">,</span> whitelistedDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span>
                    bindMountAppStorageDirs<span class="token punctuation">,</span> zygoteArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>调用 ZygoteProcess 的 start 方法，ZygoteProcess 用于保持与 Zygote 进程的通信状态：</p> <p>这里暂时就不继续追踪了，后续再单独看这部分的内容</p> <p>这里主要是调用Process.start接口来创建一个新的进程，新的进程会导入android.app.ActivityThread类，并且执行它的main函数每一个应用程序都有一个ActivityThread实例来对应的原因。</p> <p>应用程序进程创建后，会反射调用 ActivityThread 的 main 方法</p> <h1 id="四、activitythread-初始化阶段"><a href="#四、activitythread-初始化阶段" class="header-anchor">#</a> 四、ActivityThread 初始化阶段</h1> <h2 id="step-19-activitythread-main"><a href="#step-19-activitythread-main" class="header-anchor">#</a> Step 19 ActivityThread.main</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span>
        <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{</span>
        
    <span class="token comment">// 初始化 ApplicationThread</span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">final</span> <span class="token class-name">ApplicationThread</span> mAppThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> mLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化 Handler，给 ApplicationThread 与 ActivityThread 通信使用</span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">final</span> <span class="token class-name">H</span> mH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">H</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 主线程 Looper</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化 ActivityThread</span>
        <span class="token class-name">ActivityThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">,</span> <span class="token string">&quot;ActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// End of event ActivityThreadMain.</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启主线程 Looper 循环</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread loop unexpectedly exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>ActivityThread 的 attach 方法中使用 Binder 通信跨进程调用了 AMS 的 attachApplication() 方法，并将ApplicationThread 作为参数传递过去。</p> <h2 id="step-20-ams-attachapplication-attachapplicationlocked"><a href="#step-20-ams-attachapplication-attachapplicationlocked" class="header-anchor">#</a> Step 20 AMS.attachApplication-&gt;attachApplicationLocked</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid application interface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span>
        <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存当前正在运行的进程的所有信息</span>
    <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getIsolatedEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            thread<span class="token punctuation">.</span><span class="token function">runIsolatedEntryPoint</span><span class="token punctuation">(</span>
                    app<span class="token punctuation">.</span><span class="token function">getIsolatedEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getIsolatedEntryPointArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instr2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 跨进程调用 ApplicationThread 的 bindApplication 创建绑定 Application</span>
            thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> providerList<span class="token punctuation">,</span>
                    instr2<span class="token punctuation">.</span>mClass<span class="token punctuation">,</span>
                    profilerInfo<span class="token punctuation">,</span> instr2<span class="token punctuation">.</span>mArguments<span class="token punctuation">,</span>
                    instr2<span class="token punctuation">.</span>mWatcher<span class="token punctuation">,</span>
                    instr2<span class="token punctuation">.</span>mUiAutomationConnection<span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                    mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                    isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedSystemFontMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        app<span class="token punctuation">.</span><span class="token function">makeActive</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We need kill the process group here. (b/148588589)</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown during bind of &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">resetPackageList</span><span class="token punctuation">(</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">unlinkDeathRecipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">killLocked</span><span class="token punctuation">(</span><span class="token string">&quot;error during bind&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationExitInfo</span><span class="token punctuation">.</span><span class="token constant">REASON_INITIALIZATION_FAILURE</span><span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handleAppDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* fromBinderDied */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            didSomething <span class="token operator">=</span> mAtmInternal<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown launching activities in &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_20-1-分析"><a href="#_20-1-分析" class="header-anchor">#</a> 20.1 分析</h3> <p>AMS 的 attachApplication 方法在获取到 pid、uid 后继续调用 AMS 的 attachApplicationLocked 方法。AMS的 attachApplicationLocked 方法中关注以下流程：</p> <ol><li>通过跨进程通信调用应用进程中 ApplicationThread 的 bindApplication 创建并绑定 Application。</li> <li>通过 mAtmInternal.attachApplication 本地服务过渡到 ATMS 启动根 Activity。</li></ol> <p>IApplicationThread 的 bindApplication 方法调用的是应用进程中的实现类 ApplicationThread 的bindApplication 方法</p> <h2 id="step-21-applicationthread-bindapplication"><a href="#step-21-applicationthread-bindapplication" class="header-anchor">#</a> Step 21 ApplicationThread.bindApplication</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bindApplication</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> appInfo<span class="token punctuation">,</span>
        <span class="token class-name">ProviderInfoList</span> providerList<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> instrumentationName<span class="token punctuation">,</span>
        <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> instrumentationArgs<span class="token punctuation">,</span>
        <span class="token class-name">IInstrumentationWatcher</span> instrumentationWatcher<span class="token punctuation">,</span>
        <span class="token class-name">IUiAutomationConnection</span> instrumentationUiConnection<span class="token punctuation">,</span> <span class="token keyword">int</span> debugMode<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> enableBinderTracking<span class="token punctuation">,</span> <span class="token keyword">boolean</span> trackAllocation<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> isRestrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> persistent<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span>
        <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span> services<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> coreSettings<span class="token punctuation">,</span>
        <span class="token class-name">String</span> buildSerial<span class="token punctuation">,</span> <span class="token class-name">AutofillOptions</span> autofillOptions<span class="token punctuation">,</span>
        <span class="token class-name">ContentCaptureOptions</span> contentCaptureOptions<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Test code to make sure the app could see the passed-in services.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> oname <span class="token operator">:</span> services<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>oname<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// AM just passed in a null service.</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> oname<span class="token punctuation">;</span>

                <span class="token comment">// See b/79378449 about the following exemption.</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;package&quot;</span><span class="token operator">:</span>
                    <span class="token keyword">case</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token operator">:</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Service &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; should be accessible by this app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Setup the service cache in the ServiceManager</span>
        <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">initServiceCache</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">setCoreSettings</span><span class="token punctuation">(</span>coreSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>processName <span class="token operator">=</span> processName<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>appInfo <span class="token operator">=</span> appInfo<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>providers <span class="token operator">=</span> providerList<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>instrumentationName <span class="token operator">=</span> instrumentationName<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>instrumentationArgs <span class="token operator">=</span> instrumentationArgs<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>instrumentationWatcher <span class="token operator">=</span> instrumentationWatcher<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>instrumentationUiAutomationConnection <span class="token operator">=</span> instrumentationUiConnection<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>debugMode <span class="token operator">=</span> debugMode<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>enableBinderTracking <span class="token operator">=</span> enableBinderTracking<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>trackAllocation <span class="token operator">=</span> trackAllocation<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>restrictedBackupMode <span class="token operator">=</span> isRestrictedBackupMode<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>persistent <span class="token operator">=</span> persistent<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>initProfilerInfo <span class="token operator">=</span> profilerInfo<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>buildSerial <span class="token operator">=</span> buildSerial<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>autofillOptions <span class="token operator">=</span> autofillOptions<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>contentCaptureOptions <span class="token operator">=</span> contentCaptureOptions<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>disabledCompatChanges <span class="token operator">=</span> disabledCompatChanges<span class="token punctuation">;</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">BIND_APPLICATION</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>bindApplication 方法中通过内部类 H 发送 Handler 消息，进而调用到 ActivityThread 的 handleBindApplication</p> <h2 id="step-22-activitythread-handlebindapplication"><a href="#step-22-activitythread-handlebindapplication" class="header-anchor">#</a> Step 22 ActivityThread.handleBindApplication</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token comment">// core/java/android/app/ActivityThread.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConfigurationController<span class="token punctuation">.</span><span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initInstrumentation</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span> data<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">Application</span> app<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the app is being launched for full backup or restore, bring it up in</span>
        <span class="token comment">// a restricted environment with the base application class.</span>
        <span class="token comment">// 创建 Application </span>
        app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Propagate autofill compat state</span>
        app<span class="token punctuation">.</span><span class="token function">setAutofillOptions</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>autofillOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Propagate Content Capture options</span>
        app<span class="token punctuation">.</span><span class="token function">setContentCaptureOptions</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>contentCaptureOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">SET_CONTENT_CAPTURE_OPTIONS_CALLBACK</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mInitialApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> updateHttpProxy<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            updateHttpProxy <span class="token operator">=</span> mUpdateHttpProxyOnBind<span class="token punctuation">;</span>
            <span class="token comment">// This synchronized block ensures that any subsequent call to updateHttpProxy()</span>
            <span class="token comment">// will see a non-null mInitialApplication.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateHttpProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ActivityThread</span><span class="token punctuation">.</span><span class="token function">updateHttpProxy</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// don't bring up providers in restricted mode; they may depend on the</span>
        <span class="token comment">// app's custom Application class</span>
        <span class="token comment">// 初始化ContentProvider，里面会构建ContentProvider实例并调用其onCreate()方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">installContentProviders</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Do this after providers, since instrumentation tests generally start their</span>
        <span class="token comment">// test thread at this point, and we don't want that racing.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 handleBindApplication 方法中创建了 Instrumentation 实例和 Application 实例。<br>
ActivityThread 的 performLaunchActivity 方法中也有创建 Application 实例的操作，里面会先判断Application 是否已存在。<br> <strong>正常情况下 Application 的初始化是在 handleBindApplication 方法中的，并且是创建进程后调用的。performLaunchActivity 中只是做了一个检测，异常情况 Application 不存在时才会创建。</strong></p> <p>App 端 bindApplication 运行完之后，回到前面的 AMS attachApplication 方法，继续调用mAtmInternal.attachApplication</p> <h2 id="step-23-activitytaskmanagerservice-attachapplication"><a href="#step-23-activitytaskmanagerservice-attachapplication" class="header-anchor">#</a> Step 23 ActivityTaskManagerService.attachApplication</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@HotPath</span><span class="token punctuation">(</span>caller <span class="token operator">=</span> <span class="token class-name">HotPath</span><span class="token punctuation">.</span><span class="token constant">PROCESS_CHANGE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> wpc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLockWithoutBoost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;attachApplication:&quot;</span> <span class="token operator">+</span> wpc<span class="token punctuation">.</span>mName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>wpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="step-24-rootwindowcontainer-attachapplication"><a href="#step-24-rootwindowcontainer-attachapplication" class="header-anchor">#</a> Step 24 RootWindowContainer.attachApplication</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> processName <span class="token operator">=</span> app<span class="token punctuation">.</span>mName<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> display <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mTmpRemoteException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        mTmpBoolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Set to true if an activity was started.</span>
        <span class="token keyword">final</span> <span class="token class-name">PooledFunction</span> c <span class="token operator">=</span> <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">obtainFunction</span><span class="token punctuation">(</span>
                <span class="token class-name">RootWindowContainer</span><span class="token operator">::</span><span class="token function">startActivityForAttachedApplicationIfNeeded</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stack<span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTmpRemoteException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> mTmpRemoteException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        didSomething <span class="token operator">|=</span> mTmpBoolean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSomething<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* preserve_windows */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用RootWindowContainer::startActivityForAttachedApplicationIfNeeded</p> <h2 id="step-25-rootwindowcontainer-attachapplication"><a href="#step-25-rootwindowcontainer-attachapplication" class="header-anchor">#</a> Step 25 RootWindowContainer.attachApplication</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">startActivityForAttachedApplicationIfNeeded</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span>
        <span class="token class-name">WindowProcessController</span> app<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">okToShowLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>visibleIgnoringKeyguard <span class="token operator">||</span> r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span>
            <span class="token operator">||</span> app<span class="token punctuation">.</span>mUid <span class="token operator">!=</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">||</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>mName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">,</span> top <span class="token operator">==</span> r <span class="token comment">/*andResume*/</span><span class="token punctuation">,</span>
                <span class="token boolean">true</span> <span class="token comment">/*checkConfig*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTmpBoolean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception in new application when starting activity &quot;</span>
                <span class="token operator">+</span> top<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTmpRemoteException <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用mStackSupervisor.realStartActivityLocked</p> <h1 id="五、activity-启动阶段"><a href="#五、activity-启动阶段" class="header-anchor">#</a> 五、Activity 启动阶段</h1> <h2 id="step-26-activitystacksupervisor-realstartactivitylocked"><a href="#step-26-activitystacksupervisor-realstartactivitylocked" class="header-anchor">#</a> Step 26 ActivityStackSupervisor.realStartActivityLocked</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ActivityStackSupervisor.java (Android 30)</span>
<span class="token keyword">boolean</span> <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">WindowProcessController</span> proc<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构建客户端事务（ClientTransaction）</span>
    <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token class-name">ClientTransaction</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
            proc<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 添加 LaunchActivityItem（触发 Activity 实例化）</span>
    clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name">LaunchActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> proc<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>config<span class="token punctuation">,</span> r<span class="token punctuation">.</span>overrideConfig<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>activityResult<span class="token punctuation">,</span> r<span class="token punctuation">.</span>newIntents<span class="token punctuation">,</span> r<span class="token punctuation">.</span>takeFlags<span class="token punctuation">,</span>
            andResume<span class="token punctuation">,</span> proc<span class="token punctuation">.</span><span class="token function">isIsolated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">isEmbedded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>createTaskToReturn<span class="token punctuation">,</span> proc<span class="token punctuation">.</span><span class="token function">getDisplayAreaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 设置生命周期状态为 RESUME（如需立即恢复）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityLifecycleItem</span> lifecycleItem <span class="token operator">=</span> <span class="token class-name">ResumeActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
                proc<span class="token punctuation">.</span><span class="token function">getDisplayContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientTransaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>lifecycleItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3. 发送事务到应用进程（通过 Binder 调用 ApplicationThread）</span>
    mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 启动成功</span>
<span class="token punctuation">}</span>
</code></pre></div><p>scheduleTransaction 最终通过 Binder 调用应用进程 ActivityThread 的 scheduleTransaction 方法。</p> <h2 id="step-27-activitythread-scheduletransaction"><a href="#step-27-activitythread-scheduletransaction" class="header-anchor">#</a> Step 27 ActivityThread.scheduleTransaction</h2> <p>调用 ActivityThread 的 scheduleTransaction 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ActivityThread</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//ClientTransactionHandler</span>
<span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transaction<span class="token punctuation">.</span><span class="token function">preExecute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityThread<span class="token punctuation">.</span>H</span><span class="token punctuation">.</span><span class="token constant">EXECUTE_TRANSACTION</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终调用到 ActivityThread 的 sendMessage：</p> <h2 id="step-28-activitythread-sendmessage"><a href="#step-28-activitythread-sendmessage" class="header-anchor">#</a> Step 28 ActivityThread.sendMessage</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> arg1<span class="token punctuation">,</span> <span class="token keyword">int</span> arg2<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span>
                <span class="token string">&quot;SCHEDULE &quot;</span> <span class="token operator">+</span> what <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> mH<span class="token punctuation">.</span><span class="token function">codeToString</span><span class="token punctuation">(</span>what<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> arg1 <span class="token operator">+</span> <span class="token string">&quot; / &quot;</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> arg2<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后调用了 mH.sendMessage(msg)，mH 是一个 Handler 对象，mH 是在主线程创建的，所以通过 mH.sendMessage(msg) 把消息发送到了主线程。
那么前面 ApplicationThread 的 scheduleTransaction 方法执行在哪个线程呢？根据 IPC 知识，服务器的 Binder 方法运行在 Binder 线程池中，也就是说系统进行跨进程调用 ApplicationThread 的 scheduleTransaction 方法运行在 Binder 的线程池中，这样就把子线程中的消息通过 Handler 发送到了主线程。继续看 ActivityThread.H 的 handleMessage 方法：</p> <h2 id="step-29-activitythread-h-handlemessage"><a href="#step-29-activitythread-h-handlemessage" class="header-anchor">#</a> Step 29 ActivityThread.H.handleMessage</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionExecutor</span> mTransactionExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt;&gt;&gt; handling: &quot;</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token constant">EXECUTE_TRANSACTION</span><span class="token operator">:</span>
            <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> transaction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
            mTransactionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Client transactions inside system process are recycled on the client side</span>
                <span class="token comment">// instead of ClientLifecycleManager to avoid being cleared before this</span>
                <span class="token comment">// message is handled.</span>
                transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">SomeArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SomeArgs</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;&lt;&lt; done: &quot;</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>handleMessage 获取到 EXECUTE_TRANSACTION，执行 TransactionExecutor 的 execute 方法：</p> <h2 id="step-30-transactionexecutor-execute"><a href="#step-30-transactionexecutor-execute" class="header-anchor">#</a> Step 30 TransactionExecutor.execute</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// TransactionExecutor.java (Android 30)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 执行事务中的回调指令（如 LaunchActivityItem）</span>
    <span class="token function">executeCallbacks</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 执行生命周期状态请求（如 RESUME）</span>
    <span class="token function">executeLifecycleState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>executeCallbacks 会遍历事务中的回调，执行 LaunchActivityItem 的 execute 方法</p> <h2 id="step-31-launchactivityitem-execute"><a href="#step-31-launchactivityitem-execute" class="header-anchor">#</a> Step 31 LaunchActivityItem.execute</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// LaunchActivityItem.java (Android 30)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
        <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ActivityThread</span> activityThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActivityThread</span><span class="token punctuation">)</span> client<span class="token punctuation">;</span>
    <span class="token comment">// 获取 ActivityClientRecord（封装 Activity 启动信息）</span>
    <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 触发 Activity 启动核心逻辑</span>
    activityThread<span class="token punctuation">.</span><span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* customIntent */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="step-32-activitythread-handlelaunchactivity"><a href="#step-32-activitythread-handlelaunchactivity" class="header-anchor">#</a> Step 32. ActivityThread.handleLaunchActivity</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ActivityThread.java (Android 30)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化 WindowManager 等系统服务</span>
    <span class="token function">configureWindowManager</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 核心：实例化并启动 Activity</span>
    <span class="token class-name">Activity</span> a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理 Activity 恢复逻辑</span>
        <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* finalStateRequest */</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>isForward<span class="token punctuation">,</span>
                <span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="step-33-activitythread-performlaunchactivity-activity-实例化核心"><a href="#step-33-activitythread-performlaunchactivity-activity-实例化核心" class="header-anchor">#</a> Step 33. ActivityThread.performLaunchActivity（Activity 实例化核心）</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ActivityThread.java (Android 30)</span>
<span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 获取 ActivityInfo（从 AndroidManifest 解析的信息）</span>
    <span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ActivityInfo is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. 创建 ContextImpl（Activity 上下文）</span>
    <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3. 通过类加载器反射创建 Activity 实例</span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 异常处理</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4. 获取或创建 Application 实例（确保全局唯一）</span>
        <span class="token class-name">Application</span> app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 5. 关联 Activity 与上下文、Application</span>
        activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 6. 触发 Activity.onCreate()</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 异常处理</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>performLaunchActivity()主要完成以下事情：</p> <ol><li>从 ActivityClientRecord 中获取待启动的 Activity 的组件信息。</li> <li>通过 mInstrumentation.newActivity 方法使用类加载器创建 activity 实例。</li> <li>通过 LoadedApk 的 makeApplication 方法创建 Application 对象，内部也是通过 mInstrumentation 使用类加载器来创建的，创建后调用了 instrumentation.callApplicationOnCreate 方法，也就是 Application 的 onCreate()方法。</li> <li>调用 Activity 的 onCreate 方法，是通过 mInstrumentation.callActivityOnCreate 方法完成。</li></ol> <h2 id="step-34-activitythread-performlaunchactivity"><a href="#step-34-activitythread-performlaunchactivity" class="header-anchor">#</a> Step 34. ActivityThread.performLaunchActivity</h2> <p>在 performLaunchActivity 完成 Activity 实例化和 onCreate 调用后，ActivityThread 会通过 Instrumentation 触发</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ActivityThread.java (Android 30)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleStartActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Activity</span> activity <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">;</span>
    <span class="token comment">// 标记 Activity 状态为 STARTED</span>
    r<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">ON_START</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 调用 Instrumentation 触发 onStart</span>
    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnStart</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 处理 pendingActions（如权限请求、结果返回）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingActions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pendingActions<span class="token punctuation">.</span><span class="token function">setStartedActivity</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 触发 Activity.onPostCreate（若有）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnPostCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnPostCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>调用 Activity.onStart()，使 Activity 进入可见状态；</li> <li>衔接 onCreate 与 onResume，完成生命周期的过渡；</li> <li>处理配置变更、权限请求等 pending 操作。</li></ol> <p>Step 35. ActivityThread.handleResumeActivity（触发 onResume）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ActivityThread.java (Android 30)</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isForward<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> shouldSendResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 执行 Activity.onResume()</span>
    <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token function">performResumeActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> finalStateRequest<span class="token punctuation">,</span> isForward<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. 显示 Activity 窗口（与 WMS 交互）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>window <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> willBeVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>window <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">View</span> decor <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            decor<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span><span class="token constant">INVISIBLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ViewManager</span> wm <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> l <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wm<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>decor<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 DecorView 添加到 WindowManager</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 触发 onPostResume()</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnPostResume</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="启动流程总结"><a href="#启动流程总结" class="header-anchor">#</a> 启动流程总结</h1> <p>从 Launcher 点击应用图标到 Activity 显示的完整链路：</p> <ol><li>Launcher 阶段：通过 startActivitySafely 发起启动请求，经 Instrumentation 调用 ATMS；</li> <li>AMS 处理阶段：解析 Intent、创建 ActivityRecord、调度任务栈，最终触发应用进程启动；</li> <li>应用进程启动阶段：Zygote 孵化进程，初始化 ActivityThread 并绑定 Application；</li> <li>Activity 实例化阶段：通过 ClientTransaction 触发 performLaunchActivity 实例化 Activity，依次调用 onCreate() → onStart() → onResume()，最终显示界面。</li></ol> <h2 id="旧版分析总结"><a href="#旧版分析总结" class="header-anchor">#</a> 旧版分析总结</h2> <p>之前版本的流程分析，核心内容没变，分析记忆方便些
<strong>MainActivity 启动全流程的文字步骤拆解</strong>（按执行顺序划分核心阶段，每个步骤包含「操作主体+核心动作+组件交互」</p> <h1 id="mainactivity-启动全流程"><a href="#mainactivity-启动全流程" class="header-anchor">#</a> MainActivity 启动全流程</h1> <h2 id="一、阶段一-launcher-发起启动请求-用户点击应用图标后"><a href="#一、阶段一-launcher-发起启动请求-用户点击应用图标后" class="header-anchor">#</a> 一、阶段一：Launcher 发起启动请求（用户点击应用图标后）</h2> <ol><li><strong>Launcher 触发点击事件</strong>：用户点击应用图标，Launcher 的 <code>onClick</code> 方法调用 <code>startActivitySafely</code>，构建包含 <code>android.intent.action.MAIN</code> 和 <code>android.intent.category.LAUNCHER</code> 的 Intent，并添加 <code>FLAG_ACTIVITY_NEW_TASK</code> 标志。</li> <li><strong>Activity 层转发请求</strong>：通过 <code>Activity.startActivity</code> → <code>Activity.startActivityForResult</code> 转发，最终调用 <code>mInstrumentation.execStartActivity</code>（Instrumentation 作为系统与应用的桥梁）。</li> <li><strong>跨进程调用 AMS</strong>：<code>Instrumentation</code> 获取 AMS 的远程代理 <code>ActivityManagerProxy</code>，通过 Binder 通信调用 <code>ActivityManagerProxy.startActivity</code>，将请求发送到系统进程的 <code>ActivityManagerService</code>（AMS）。</li> <li><strong>AMS 栈管理预处理</strong>：
<ul><li>AMS 调用 <code>ActivityStack.startActivityMayWait</code>，解析目标 Activity 的 <code>ActivityInfo</code>（从 AndroidManifest 中获取）。</li> <li>依次执行 <code>ActivityStack.startActivityLocked</code>（创建 <code>ActivityRecord</code> 记录 Activity 状态）→ <code>ActivityStack.startActivityUncheckedLocked</code>（创建新 Task 用于存放 MainActivity）。</li> <li>调用 <code>ActivityStack.resumeTopActivityLocked</code>，检测到当前活跃的是 Launcher，需先暂停 Launcher。</li></ul></li></ol> <h2 id="二、阶段二-暂停前序-activity-launcher-进入-paused-状态"><a href="#二、阶段二-暂停前序-activity-launcher-进入-paused-状态" class="header-anchor">#</a> 二、阶段二：暂停前序 Activity（Launcher 进入 Paused 状态）</h2> <ol start="5"><li><strong>AMS 通知 Launcher 暂停</strong>：<code>ActivityStack.startPausingLocked</code> 通过 <code>ApplicationThreadProxy.schedulePauseActivity</code>（AMS 到 Launcher 进程的 Binder 代理）发送暂停请求。</li> <li><strong>Launcher 进程处理暂停</strong>：
<ul><li>Binder 通信将请求传递到 Launcher 进程的 <code>ApplicationThread</code>，其发送 <code>PAUSE_ACTIVITY</code> 消息到 <code>ActivityThread</code> 的消息队列。</li> <li><code>ActivityThread</code> 的 Handler <code>H</code> 处理消息，调用 <code>ActivityThread.handlePauseActivity</code>，最终执行 Launcher 的 <code>onPause</code> 生命周期方法。</li></ul></li> <li><strong>通知 AMS 暂停完成</strong>：Launcher 暂停后，通过 <code>ActivityManagerProxy.activityPaused</code> 向 AMS 反馈“已暂停”，完成跨进程通信闭环。</li></ol> <h2 id="三、阶段三-ams-创建-mainactivity-所属进程"><a href="#三、阶段三-ams-创建-mainactivity-所属进程" class="header-anchor">#</a> 三、阶段三：AMS 创建 MainActivity 所属进程</h2> <ol start="8"><li><strong>AMS 触发进程创建</strong>：AMS 收到 Launcher 暂停反馈后，执行 <code>ActivityStack.activityPaused</code> → <code>ActivityStack.completePauseLocked</code>，再次调用 <code>ActivityStack.resumeTopActivityLocked</code>，检测到 MainActivity 对应的进程未创建，触发 <code>ActivityStack.startSpecificActivityLocked</code>。</li> <li><strong>AMS 发起进程创建请求</strong>：<code>ActivityManagerService.startProcessLocked</code> 调用 <code>Process.start</code>（底层通过 <code>fork/exec</code> 系统调用），创建新的应用进程（MainActivity 运行在该进程中）。</li> <li><strong>新进程初始化</strong>：
<ul><li>新进程启动后，执行 <code>ActivityThread.main</code> 方法（应用进程的入口），初始化 <code>ActivityThread</code>、创建主线程消息队列。</li> <li>调用 <code>ActivityThread.attach</code> 方法，通过 <code>ActivityManagerProxy.attachApplication</code> 将 <code>ApplicationThread</code>（应用进程的 Binder 服务端）传递给 AMS，建立 AMS 与新进程的通信链路。</li></ul></li></ol> <h2 id="四、阶段四-ams-与新进程绑定通信"><a href="#四、阶段四-ams-与新进程绑定通信" class="header-anchor">#</a> 四、阶段四：AMS 与新进程绑定通信</h2> <ol start="11"><li><strong>AMS 绑定进程与 Activity</strong>：AMS 收到 <code>attachApplication</code> 请求后，执行 <code>ActivityManagerService.attachApplicationLocked</code>，将新进程的 <code>ProcessRecord</code>（进程状态记录）与 MainActivity 的 <code>ActivityRecord</code> 绑定。</li> <li><strong>确认启动目标</strong>：AMS 从栈顶获取 MainActivity 的 <code>ActivityRecord</code>，准备发起 Activity 启动指令。</li></ol> <h2 id="五、阶段五-启动-mainactivity-并执行生命周期"><a href="#五、阶段五-启动-mainactivity-并执行生命周期" class="header-anchor">#</a> 五、阶段五：启动 MainActivity 并执行生命周期</h2> <ol start="13"><li><strong>AMS 通知新进程启动 Activity</strong>：<code>ActivityStack.realStartActivityLocked</code> 通过 <code>ApplicationThreadProxy.scheduleLaunchActivity</code>（AMS 到新进程的 Binder 代理）发送启动请求，携带 <code>ActivityRecord</code> 中的配置信息（如组件名、Intent、主题等）。</li> <li><strong>新进程处理启动请求</strong>：
<ul><li>Binder 通信将请求传递到新进程的 <code>ApplicationThread</code>，其创建 <code>ActivityClientRecord</code>（封装 Activity 启动信息），并发送 <code>LAUNCH_ACTIVITY</code> 消息到 <code>ActivityThread</code> 的消息队列。</li> <li>主线程 Handler <code>H</code> 处理 <code>LAUNCH_ACTIVITY</code> 消息，调用 <code>ActivityThread.handleLaunchActivity</code>。</li></ul></li> <li><strong>初始化 Activity 上下文</strong>：<code>ActivityThread.performLaunchActivity</code> 执行核心初始化：
<ul><li>加载 MainActivity 类（通过类加载器 <code>ClassLoader</code>）。</li> <li>创建 <code>Application</code> 实例（若未创建），初始化 <code>ContextImpl</code>（Activity 的上下文）。</li> <li>调用 <code>Activity.attach</code> 方法，将上下文、<code>ActivityManagerProxy</code> 等绑定到 MainActivity。</li></ul></li> <li><strong>执行 MainActivity 生命周期</strong>：<code>mInstrumentation.callActivityOnCreate</code> 调用 MainActivity 的 <code>onCreate</code> 方法，加载布局、初始化控件，后续依次执行 <code>onStart</code> → <code>onResume</code>，MainActivity 最终显示在屏幕上。</li></ol> <h2 id="核心流程总结-简化版"><a href="#核心流程总结-简化版" class="header-anchor">#</a> 核心流程总结（简化版）</h2> <p>用户点击图标 → Launcher 发起请求 → AMS 暂停 Launcher → AMS 创建新进程 → 新进程与 AMS 绑定 → AMS 通知新进程启动 Activity → 新进程初始化 Activity 并执行生命周期 → MainActivity 显示。</p> <h2 id="关键跨进程通信-ipc-点"><a href="#关键跨进程通信-ipc-点" class="header-anchor">#</a> 关键跨进程通信（IPC）点</h2> <ol><li>Launcher 进程 → 系统进程（AMS）：通过 <code>ActivityManagerProxy</code> 发起启动请求。</li> <li>系统进程（AMS）→ Launcher 进程：通过 <code>ApplicationThreadProxy</code> 通知暂停。</li> <li>新进程 → 系统进程（AMS）：通过 <code>ActivityManagerProxy</code> 绑定 <code>ApplicationThread</code>。</li> <li>系统进程（AMS）→ 新进程：通过 <code>ApplicationThreadProxy</code> 通知启动 Activity。</li></ol> <h2 id="应用内启动"><a href="#应用内启动" class="header-anchor">#</a> 应用内启动</h2> <p>主要是在startActivityUncheckedLocked 里面判断参数intent的标志位<strong>Intent.FLAG_ACTIVITY_NEW_TASK</strong>没有设置，启动模式launchMode也是普通模式时，r.task = sourceRecord.task ，运行在同一个Task中,然后不会调用AMS.startProcessLocked,后续startSpecificActivityLocked时，getProcessRecordLocked不为空，所以直接执行realStartActivityLocked</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-1-launcher-startactivitysafely" class="sidebar-link reco-side-step-1-launcher-startactivitysafely" data-v-b57cc07c>Step 1.Launcher.startActivitySafely</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_1-1分析" class="sidebar-link reco-side-_1-1分析" data-v-b57cc07c>1.1分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-2-activity-startactivity" class="sidebar-link reco-side-step-2-activity-startactivity" data-v-b57cc07c>Step 2. Activity.startActivity</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_2-1-相关分析" class="sidebar-link reco-side-_2-1-相关分析" data-v-b57cc07c>2.1 相关分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-3-activity-startactivityforresult" class="sidebar-link reco-side-step-3-activity-startactivityforresult" data-v-b57cc07c>Step 3. Activity.startActivityForResult</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_3-1-相关分析" class="sidebar-link reco-side-_3-1-相关分析" data-v-b57cc07c>3.1 相关分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-4-instrumentation-execstartactivity" class="sidebar-link reco-side-step-4-instrumentation-execstartactivity" data-v-b57cc07c>Step 4. Instrumentation.execStartActivity</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_4-1-相关分析" class="sidebar-link reco-side-_4-1-相关分析" data-v-b57cc07c>4.1 相关分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-5-activitytaskmanagerservice-startactivity" class="sidebar-link reco-side-step-5-activitytaskmanagerservice-startactivity" data-v-b57cc07c>Step 5. ActivityTaskManagerService.startActivity</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_5-1分析" class="sidebar-link reco-side-_5-1分析" data-v-b57cc07c>5.1分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-6-activitystarter-execute" class="sidebar-link reco-side-step-6-activitystarter-execute" data-v-b57cc07c>Step 6. ActivityStarter.execute</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_6-1-分析" class="sidebar-link reco-side-_6-1-分析" data-v-b57cc07c>6.1 分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-7-activitystarter-startactivityunchecked" class="sidebar-link reco-side-step-7-activitystarter-startactivityunchecked" data-v-b57cc07c>Step 7. ActivityStarter.startActivityUnchecked</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_7-1-分析" class="sidebar-link reco-side-_7-1-分析" data-v-b57cc07c>7.1 分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-8-startactivityinner" class="sidebar-link reco-side-step-8-startactivityinner" data-v-b57cc07c>Step 8. startActivityInner</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_8-1-分析" class="sidebar-link reco-side-_8-1-分析" data-v-b57cc07c>8.1 分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-9-rootwindowcontainer-resumefocusedstackstopactivities" class="sidebar-link reco-side-step-9-rootwindowcontainer-resumefocusedstackstopactivities" data-v-b57cc07c>Step 9. RootWindowContainer.resumeFocusedStacksTopActivities</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-10-activitystack-resumefocusedtaskstopactivities" class="sidebar-link reco-side-step-10-activitystack-resumefocusedtaskstopactivities" data-v-b57cc07c>Step 10.ActivityStack.resumeFocusedTasksTopActivities</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-11-activitystack-resumetopactivityinnerlocked" class="sidebar-link reco-side-step-11-activitystack-resumetopactivityinnerlocked" data-v-b57cc07c>Step 11. ActivityStack.resumeTopActivityInnerLocked</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_11-1分析" class="sidebar-link reco-side-_11-1分析" data-v-b57cc07c>11.1分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-12-activitystacksupervisor-startspecificactivity" class="sidebar-link reco-side-step-12-activitystacksupervisor-startspecificactivity" data-v-b57cc07c>Step 12. ActivityStackSupervisor.startSpecificActivity</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_12-1-分析" class="sidebar-link reco-side-_12-1-分析" data-v-b57cc07c>12.1 分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-13-activitytaskmanagerservice-startprocessasync" class="sidebar-link reco-side-step-13-activitytaskmanagerservice-startprocessasync" data-v-b57cc07c>Step   13.ActivityTaskManagerService.startProcessAsync</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#" class="sidebar-link reco-side-" data-v-b57cc07c></a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-14-ams-localservice-startprocess" class="sidebar-link reco-side-step-14-ams-localservice-startprocess" data-v-b57cc07c>Step 14 AMS.LocalService.startProcess</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-15-ams-startprocesslocked" class="sidebar-link reco-side-step-15-ams-startprocesslocked" data-v-b57cc07c>Step 15 AMS.startProcessLocked</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-16-processlist-startprocesslocked" class="sidebar-link reco-side-step-16-processlist-startprocesslocked" data-v-b57cc07c>Step 16 ProcessList.startProcessLocked</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-17-processlist-startprocess" class="sidebar-link reco-side-step-17-processlist-startprocess" data-v-b57cc07c>Step 17 ProcessList.startProcess</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-18-process-start" class="sidebar-link reco-side-step-18-process-start" data-v-b57cc07c>Step 18 Process.start</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-19-activitythread-main" class="sidebar-link reco-side-step-19-activitythread-main" data-v-b57cc07c>Step 19 ActivityThread.main</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-20-ams-attachapplication-attachapplicationlocked" class="sidebar-link reco-side-step-20-ams-attachapplication-attachapplicationlocked" data-v-b57cc07c>Step 20 AMS.attachApplication-&gt;attachApplicationLocked</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#_20-1-分析" class="sidebar-link reco-side-_20-1-分析" data-v-b57cc07c>20.1 分析</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-21-applicationthread-bindapplication" class="sidebar-link reco-side-step-21-applicationthread-bindapplication" data-v-b57cc07c>Step 21 ApplicationThread.bindApplication</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-22-activitythread-handlebindapplication" class="sidebar-link reco-side-step-22-activitythread-handlebindapplication" data-v-b57cc07c>Step 22 ActivityThread.handleBindApplication</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-23-activitytaskmanagerservice-attachapplication" class="sidebar-link reco-side-step-23-activitytaskmanagerservice-attachapplication" data-v-b57cc07c>Step 23 ActivityTaskManagerService.attachApplication</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-24-rootwindowcontainer-attachapplication" class="sidebar-link reco-side-step-24-rootwindowcontainer-attachapplication" data-v-b57cc07c>Step 24 RootWindowContainer.attachApplication</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-25-rootwindowcontainer-attachapplication" class="sidebar-link reco-side-step-25-rootwindowcontainer-attachapplication" data-v-b57cc07c>Step 25 RootWindowContainer.attachApplication</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-26-activitystacksupervisor-realstartactivitylocked" class="sidebar-link reco-side-step-26-activitystacksupervisor-realstartactivitylocked" data-v-b57cc07c>Step 26 ActivityStackSupervisor.realStartActivityLocked</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-27-activitythread-scheduletransaction" class="sidebar-link reco-side-step-27-activitythread-scheduletransaction" data-v-b57cc07c>Step 27 ActivityThread.scheduleTransaction</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-28-activitythread-sendmessage" class="sidebar-link reco-side-step-28-activitythread-sendmessage" data-v-b57cc07c>Step 28 ActivityThread.sendMessage</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-29-activitythread-h-handlemessage" class="sidebar-link reco-side-step-29-activitythread-h-handlemessage" data-v-b57cc07c>Step 29 ActivityThread.H.handleMessage</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-30-transactionexecutor-execute" class="sidebar-link reco-side-step-30-transactionexecutor-execute" data-v-b57cc07c>Step 30 TransactionExecutor.execute</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-31-launchactivityitem-execute" class="sidebar-link reco-side-step-31-launchactivityitem-execute" data-v-b57cc07c>Step 31 LaunchActivityItem.execute</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-32-activitythread-handlelaunchactivity" class="sidebar-link reco-side-step-32-activitythread-handlelaunchactivity" data-v-b57cc07c>Step 32. ActivityThread.handleLaunchActivity</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-33-activitythread-performlaunchactivity-activity-实例化核心" class="sidebar-link reco-side-step-33-activitythread-performlaunchactivity-activity-实例化核心" data-v-b57cc07c>Step 33. ActivityThread.performLaunchActivity（Activity 实例化核心）</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#step-34-activitythread-performlaunchactivity" class="sidebar-link reco-side-step-34-activitythread-performlaunchactivity" data-v-b57cc07c>Step 34. ActivityThread.performLaunchActivity</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#旧版分析总结" class="sidebar-link reco-side-旧版分析总结" data-v-b57cc07c>旧版分析总结</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#一、阶段一-launcher-发起启动请求-用户点击应用图标后" class="sidebar-link reco-side-一、阶段一-launcher-发起启动请求-用户点击应用图标后" data-v-b57cc07c>一、阶段一：Launcher 发起启动请求（用户点击应用图标后）</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#二、阶段二-暂停前序-activity-launcher-进入-paused-状态" class="sidebar-link reco-side-二、阶段二-暂停前序-activity-launcher-进入-paused-状态" data-v-b57cc07c>二、阶段二：暂停前序 Activity（Launcher 进入 Paused 状态）</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#三、阶段三-ams-创建-mainactivity-所属进程" class="sidebar-link reco-side-三、阶段三-ams-创建-mainactivity-所属进程" data-v-b57cc07c>三、阶段三：AMS 创建 MainActivity 所属进程</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#四、阶段四-ams-与新进程绑定通信" class="sidebar-link reco-side-四、阶段四-ams-与新进程绑定通信" data-v-b57cc07c>四、阶段四：AMS 与新进程绑定通信</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#五、阶段五-启动-mainactivity-并执行生命周期" class="sidebar-link reco-side-五、阶段五-启动-mainactivity-并执行生命周期" data-v-b57cc07c>五、阶段五：启动 MainActivity 并执行生命周期</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#核心流程总结-简化版" class="sidebar-link reco-side-核心流程总结-简化版" data-v-b57cc07c>核心流程总结（简化版）</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#关键跨进程通信-ipc-点" class="sidebar-link reco-side-关键跨进程通信-ipc-点" data-v-b57cc07c>关键跨进程通信（IPC）点</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/blogs/android/read-source-code/%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.html#应用内启动" class="sidebar-link reco-side-应用内启动" data-v-b57cc07c>应用内启动</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blogs/assets/js/app.f7ee3a0f.js" defer></script><script src="/blogs/assets/js/7.1cee44e5.js" defer></script><script src="/blogs/assets/js/2.c6a51781.js" defer></script><script src="/blogs/assets/js/1.72bf0bc0.js" defer></script><script src="/blogs/assets/js/42.1e110cc6.js" defer></script>
  </body>
</html>
